@using HomeBook.Frontend.Abstractions.Contracts
@using HomeBook.Frontend.Abstractions.Enums
@using Microsoft.AspNetCore.Components.Authorization
@using NavigationContext = Microsoft.AspNetCore.Components.Routing.NavigationContext

<CascadingAuthenticationState>

    <Router AppAssembly="@typeof(App).Assembly"
            OnNavigateAsync="HandleNavigationAsync">

        <Found Context="routeData">

            <AuthorizeRouteView RouteData="@routeData"
                                DefaultLayout="@typeof(MainLayout)">

                <NotAuthorized>

                    <MudGrid Justify="Justify.Center"
                             Class="mt-20">
                        <MudItem Class="pa-0">
                            <MudAlert Severity="Severity.Error"
                                      Variant="Variant.Filled">
                                MainLayout_NotAuthorizedText
                            </MudAlert>
                        </MudItem>
                    </MudGrid>

                </NotAuthorized>

            </AuthorizeRouteView>

            <FocusOnNavigate RouteData="@routeData" Selector="h1"/>

        </Found>

        <NotFound>

            <PageTitle>Not found</PageTitle>

            <LayoutView Layout="@typeof(MainLayout)">
                <p role="alert">Sorry, there's nothing at this address.</p>
            </LayoutView>

        </NotFound>

    </Router>

</CascadingAuthenticationState>

@code {

    [Inject]
    private NavigationManager NavigationManager { get; set; } = null!;

    [Inject]
    private IStartupService StartupService { get; set; } = null!;

    [Inject]
    private ISetupService SetupService { get; set; } = null!;

    [Inject]
    private IAuthenticationService AuthenticationService { get; set; } = null!;

    private bool _setupServiceInitialized = false;
    private bool _isRedirecting;
    private InstanceStatus? _instanceStatus;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        // initialize the setup service in background
        _ = Task.Run(async () =>
        {
            CancellationToken cancellationToken = CancellationToken.None;

            // TODO: improve loading from instance status and after loading logic (it makes two times the request for availablity)
            await SetupService.InitializeAsync(cancellationToken);
            await WaitForServerAndGetSetupStatusAsync(cancellationToken);

            await StartupService.StartAsync(_instanceStatus!.Value,
                cancellationToken);

            _setupServiceInitialized = true;
            StateHasChanged();
        });
    }

    private async Task WaitForServerAndGetSetupStatusAsync(CancellationToken cancellationToken)
    {
        try
        {
            _instanceStatus = await SetupService.GetInstanceStatusAsync(cancellationToken);
        }
        catch (HttpRequestException err) when (err.Message.ToLowerInvariant().Contains("failed to fetch"))
        {
            await WaitForServerAndGetSetupStatusAsync(cancellationToken);
        }
        catch (Exception)
        {
            // TODO: display error or log error
        }
    }

    private async Task HandleNavigationAsync(NavigationContext context)
    {
        if (_isRedirecting)
        {
            _isRedirecting = false;
            return;
        }

        // wait until SetupService is initialized
        while (!_setupServiceInitialized)
        {
            await Task.Delay(50);
        }

        bool isOnSetupPage = context.Path.StartsWith("setup", StringComparison.OrdinalIgnoreCase);
        if ((_instanceStatus == InstanceStatus.SetupRequired
             || _instanceStatus == InstanceStatus.UpdateRequired)
            && !isOnSetupPage)
        {
            _isRedirecting = true;
            NavigationManager.NavigateTo("/setup");
            return;
        }

        if (_instanceStatus != InstanceStatus.Running)
            return;

        bool isOnLoginPage = context.Path.StartsWith("login", StringComparison.OrdinalIgnoreCase);
        if (isOnLoginPage)
            return;

        bool isAuthenticated = await AuthenticationService.IsAuthenticatedAsync();
        if (!isAuthenticated)
        {
            _isRedirecting = true;
            NavigationManager.NavigateTo("/login");
            return;
        }
    }

}
