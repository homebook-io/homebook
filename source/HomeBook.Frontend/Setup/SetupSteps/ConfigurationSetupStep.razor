@using HomeBook.Client
@using HomeBook.Frontend.Abstractions.Contracts
@using HomeBook.Frontend.Core.Models.Setup
@using HomeBook.Frontend.UI.Resources
@using Microsoft.Extensions.Localization

@inject IStringLocalizer<LocalizationStrings> Loc
@inject ISetupService SetupService
@inject BackendClient BackendClient

<MudCard Class="frosted-b3 mud-elevation-6">

    <MudCardHeader Class="no-divider">
        <CardHeaderContent>
            <MudText Typo="Typo.h4" Color="Color.Inherit">
                @Loc[nameof(LocalizationStrings.Setup_Configuration_Title)]
            </MudText>
        </CardHeaderContent>
    </MudCardHeader>

    <MudCardContent Class="no-divider">

        @if (_isChecking)
        {
            <div class="relative d-flex flex-grow-1 flex-wrap flex-column justify-center align-center">
                <MudProgressLinear Color="Color.Primary"
                                   Indeterminate="true"
                                   Class="my-7"/>
            </div>
        }

        <EditForm Model="@_homebookConfiguration"
                  OnValidSubmit="OnValidSubmit">

            @if (!_isChecking)
            {
                @if (_configurationIsOk)
                {
                    <UiCountdownAlert Class="mt-3"
                                      Duration="TimeSpan.FromSeconds(5)"
                                      OnFinished="async () => await OnCountdownFinishedAsync()"
                                      Severity="Severity.Info">
                        @if (_preConfigured)
                        {
                            <MudText>
                                @Loc[nameof(LocalizationStrings.Setup_Configuration_ConfigurationFound_Title)]
                            </MudText>
                        }
                        else
                        {
                            <MudText>
                                @Loc[nameof(LocalizationStrings.Setup_Configuration_ConfigurationSaved_Title)]
                            </MudText>
                        }
                    </UiCountdownAlert>
                }

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <MudAlert Class="mt-3 mb-3"
                              Severity="Severity.Error">
                        @_errorMessage
                    </MudAlert>
                }
            }

            <DataAnnotationsValidator/>

            @if (!_isChecking && !_configurationIsOk)
            {
                <MudGrid>

                    <MudItem xs="12">
                        <MudTextField @bind-Value="_homebookConfiguration.InstanceName"
                                      Margin="Margin.Dense"
                                      Label="@Loc[nameof(LocalizationStrings.Setup_Configuration_Form_InstanceName_Label)]"
                                      HelperText="@Loc[nameof(LocalizationStrings.Setup_Configuration_Form_InstanceName_HelperText)]"
                                      For="@(() => _homebookConfiguration.InstanceName)"
                                      Required="true"
                                      Clearable="true"
                                      Variant="Variant.Outlined"/>
                    </MudItem>

                    <MudItem xs="12">
                        <MudSelect @bind-Value="_homebookConfiguration.InstanceDefaultLocale"
                                   Variant="Variant.Outlined"
                                   Margin="Margin.Dense"
                                   Dense="true"
                                   Label="@Loc[nameof(LocalizationStrings.Setup_Configuration_Form_InstanceDefaultLocale_Label)]"
                                   HelperText="@Loc[nameof(LocalizationStrings.Setup_Configuration_Form_InstanceDefaultLocale_HelperText)]"
                                   For="@(() => _homebookConfiguration.InstanceDefaultLocale)"
                                   Required="true"
                                   Clearable="true">
                            @foreach (LanguageViewModel language in _availableLanguages)
                            {
                                <MudSelectItem Value="language.Key">@language.DisplayName</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                </MudGrid>

                <MudStack Row Justify="Justify.SpaceBetween"
                          AlignItems="AlignItems.Center">

                    <MudButton ButtonType="ButtonType.Submit"
                               Color="Color.Primary"
                               Variant="Variant.Filled"
                               Class="mt-3"
                               Disabled="@_isChecking">

                        <MudText>
                            @Loc[nameof(LocalizationStrings.Setup_Configuration_Save_Button_Text)]
                        </MudText>

                    </MudButton>

                </MudStack>
            }

        </EditForm>

    </MudCardContent>

</MudCard>
