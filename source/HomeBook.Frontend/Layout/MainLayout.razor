@using HomeBook.Frontend.Abstractions.Contracts
@using HomeBook.Frontend.Themes
@using Microsoft.AspNetCore.Components.Authorization
@inherits LayoutComponentBase
@inject IAuthenticationService AuthenticationService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

@* Required *@
<MudThemeProvider Theme="HomebookTheme.GetTheme()"/>
<MudPopoverProvider/>

@* Needed for dialogs *@
<MudDialogProvider/>

@* Needed for snackbars *@
<MudSnackbarProvider/>

<MudLayout Class="pb-20">

    <MudAppBar Color="Color.Primary" Elevation="1">

        <MudIconButton Icon="@Icons.Material.TwoTone.Home"
                       Href="/"
                       Color="Color.Inherit"/>
        <MudText Typo="Typo.h5" Class="ml-3">HomeBook</MudText>

        <MudSpacer/>

        <AuthorizeView>

            <Authorized>

                <MudMenu Dense
                         Icon="@Icons.Material.TwoTone.AccountCircle"
                         Color="Color.Inherit"
                         Direction="Direction.Bottom"
                         OffsetX="true">

                    <MudMenuItem Icon="@Icons.Material.Filled.Person"
                                 IconColor="Color.Primary"
                                 Label="@context.User.Identity?.Name"/>

                    <MudDivider/>

                    <MudMenuItem Icon="@Icons.Material.TwoTone.Logout"
                                 IconColor="Color.Primary"
                                 OnClick="HandleLogoutAsync"
                                 Label="Logout"/>

                </MudMenu>

                <MudMenu Dense
                         Variant="Variant.Text"
                         Size="Size.Medium"
                         Color="Color.Inherit"
                         Icon="@Icons.Material.TwoTone.MoreVert">

                    <MudMenuItem Icon="@Icons.Material.TwoTone.Settings"
                                 IconColor="Color.Primary"
                                 Href="/Settings"
                                 Label="Settings"/>
                </MudMenu>

            </Authorized>

            <NotAuthorized>
                <MudIconButton Icon="@Icons.Material.Filled.Login"
                               Color="Color.Inherit"
                               Edge="Edge.End"
                               OnClick="NavigateToLogin"/>
            </NotAuthorized>

        </AuthorizeView>

    </MudAppBar>

    <MudMainContent>
        @Body
    </MudMainContent>

    <MudAppBar Bottom="true" Color="Color.Tertiary" Elevation="1">

        <MudText Class="me-5" Typo="Typo.caption">HomeBook</MudText>
        <MudText Typo="Typo.caption">made with ❤️ by&nbsp;</MudText>
        <MudLink Href="https://www.lk-code.dev"
                 Target="_blank"
                 Color="Color.Inherit"
                 Typo="Typo.caption">
            <MudText Typo="Typo.caption">lk-code</MudText>
        </MudLink>

        <MudSpacer/>

        <MudIconButton Icon="@Icons.Material.Filled.MoreVert" Color="Color.Inherit" Edge="Edge.End"/>

    </MudAppBar>

</MudLayout>

@code {

    private async Task HandleLogoutAsync()
    {
        try
        {
            await AuthenticationService.LogoutAsync();
            Snackbar.Add("Logged out successfully!", Severity.Success);
            NavigationManager.NavigateTo("/Login");
        }
        catch
        {
            Snackbar.Add("Error during logout!", Severity.Error);
        }
    }

    private void NavigateToLogin()
    {
        NavigationManager.NavigateTo("/Login");
    }

}
