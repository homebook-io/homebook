@using HomeBook.Frontend.Abstractions.Contracts
@using HomeBook.Frontend.Abstractions.Enums
@using HomeBook.Frontend.Core.Icons
@using HomeBook.Frontend.Properties
@using HomeBook.Frontend.Themes
@using Microsoft.AspNetCore.Components.Authorization

@inherits LayoutComponentBase

@inject ILocalizationProvider Loc
@inject IAuthenticationService AuthenticationService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IJsLocalStorageProvider JsLocalStorageProvider

@* Required *@
<MudThemeProvider Theme="HomebookTheme.GetTheme()"/>
<MudPopoverProvider/>

@* Needed for dialogs *@
<MudDialogProvider/>

@* Needed for snackbars *@
<MudSnackbarProvider/>

<MudLayout Class="pb-20">

    <MudAppBar Color="Color.Primary"
               Elevation="1">

        <MudIconButton Icon="@HomeBookIcons.Icons8.Windows11.Filled.Home"
                       Href="/"
                       Color="Color.Inherit"/>
        <MudText Typo="Typo.h5"
                 Class="ml-3">
            @(_homebookInstanceName + " - " ?? string.Empty)@Loc[nameof(LocalizationStrings.AppTitle)]
        </MudText>

        <MudSpacer/>

        <AuthorizeView>

            <Authorized>

                <MudMenu Dense
                         Icon="@HomeBookIcons.Icons8.Windows11.Filled.Profile"
                         Color="Color.Inherit">

                    <MudMenuItem Icon="@HomeBookIcons.Icons8.Windows11.Filled.User"
                                 IconColor="Color.Primary"
                                 Label="@context.User.Identity?.Name"/>

                    <MudDivider/>

                    <MudMenuItem Icon="@HomeBookIcons.Icons8.Windows11.Filled.LogoutRounded"
                                 IconColor="Color.Primary"
                                 OnClick="HandleLogoutAsync"
                                 Label="Logout"/>

                </MudMenu>

                <MudMenu Dense
                         Variant="Variant.Text"
                         Size="Size.Medium"
                         Color="Color.Inherit"
                         Icon="@HomeBookIcons.Icons8.Windows11.Filled.More">

                    <MudMenuItem Icon="@HomeBookIcons.Icons8.Windows11.Filled.Gear"
                                 IconColor="Color.Primary"
                                 Href="/Settings"
                                 Label="Settings"/>
                </MudMenu>

            </Authorized>

            <NotAuthorized>
                <MudIconButton Icon="@HomeBookIcons.Icons8.Windows11.Filled.LoginRounded"
                               Color="Color.Inherit"
                               Edge="Edge.End"
                               OnClick="NavigateToLogin"/>
            </NotAuthorized>

        </AuthorizeView>

    </MudAppBar>

    <MudMainContent>
        @Body
    </MudMainContent>

    <MudAppBar Bottom="true" Color="Color.Tertiary" Elevation="1">

        <MudText Class="me-5" Typo="Typo.caption">HomeBook</MudText>
        <MudText Typo="Typo.caption">made with ❤️ by&nbsp;</MudText>
        <MudLink Href="https://www.lk-code.dev"
                 Target="_blank"
                 Color="Color.Inherit"
                 Typo="Typo.caption">
            <MudText Typo="Typo.caption">lk-code</MudText>
        </MudLink>

        <MudSpacer/>

        <MudIconButton Icon="@Icons.Material.Filled.MoreVert" Color="Color.Inherit" Edge="Edge.End"/>

    </MudAppBar>

</MudLayout>

@code {

    private string? _homebookInstanceName = null;

    protected override async Task OnInitializedAsync()
    {
        CancellationToken cancellationToken = CancellationToken.None;
        _homebookInstanceName = await JsLocalStorageProvider.GetItemAsync(JsLocalStorageKeys.HomeBookInstanceName,
            cancellationToken);

        await base.OnInitializedAsync();
    }

    private async Task HandleLogoutAsync()
    {
        try
        {
            await AuthenticationService.LogoutAsync();
            Snackbar.Add("Logged out successfully!", Severity.Success);
            NavigationManager.NavigateTo("/Login");
        }
        catch
        {
            Snackbar.Add("Error during logout!", Severity.Error);
        }
    }

    private void NavigateToLogin()
    {
        NavigationManager.NavigateTo("/Login");
    }

}
