@using HomeBook.Frontend.Abstractions.Contracts
@using HomeBook.Frontend.Themes
@using Microsoft.AspNetCore.Components.Authorization
@inherits LayoutComponentBase
@inject IAuthenticationService AuthenticationService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

@* Required *@
<MudThemeProvider Theme="HomebookTheme.GetTheme()"/>
<MudPopoverProvider/>

@* Needed for dialogs *@
<MudDialogProvider/>

@* Needed for snackbars *@
<MudSnackbarProvider/>

<MudLayout>

    <MudAppBar Elevation="1">

        <MudText Typo="Typo.h5" Class="ml-3">HomeBook</MudText>

        <MudSpacer/>

        <AuthorizeView>

            <Authorized>
                <MudMenu Icon="@Icons.Material.Filled.AccountCircle"
                         Color="Color.Inherit"
                         Direction="Direction.Bottom"
                         OffsetX="true">
                    <MudMenuItem Icon="@Icons.Material.Filled.Person">
                        <MudText>@context.User.Identity?.Name</MudText>
                    </MudMenuItem>
                    <MudDivider/>
                    <MudMenuItem Icon="@Icons.Material.Filled.Logout"
                                 OnClick="HandleLogoutAsync">
                        Logout
                    </MudMenuItem>
                </MudMenu>
            </Authorized>

            <NotAuthorized>
                <MudIconButton Icon="@Icons.Material.Filled.Login"
                               Color="Color.Inherit"
                               Edge="Edge.End"
                               OnClick="NavigateToLogin"/>
            </NotAuthorized>

        </AuthorizeView>

    </MudAppBar>

    <MudMainContent>
        @Body
    </MudMainContent>

</MudLayout>

@code {

    private async Task HandleLogoutAsync()
    {
        try
        {
            await AuthenticationService.LogoutAsync();
            Snackbar.Add("Logged out successfully!", Severity.Success);
            NavigationManager.NavigateTo("/Login");
        }
        catch
        {
            Snackbar.Add("Error during logout!", Severity.Error);
        }
    }

    private void NavigateToLogin()
    {
        NavigationManager.NavigateTo("/Login");
    }

}
