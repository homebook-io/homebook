@page "/Settings/Users"

@using HomeBook.Frontend.Abstractions.Contracts
@using HomeBook.Frontend.UI.Resources
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.Extensions.Localization

@attribute [Authorize(Roles = "Admin")]

@inject IStringLocalizer<LocalizationStrings> Loc
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IUserManagementProvider UserManagementProvider

<MudContainer>

    <MudGrid>

        <MudItem xs="12" sm="12" md="4" lg="3" xl="3" xxl="3">

            <SettingsNavMenu/>

        </MudItem>

        <MudItem xs="12" sm="12" md="8" lg="9" xl="9" xxl="9">

            <MudPaper Class="pa-4">

                <MudGrid Class="mb-4">

                    <MudItem xs="6">
                        <MudText Typo="Typo.h5">
                            @Loc[nameof(LocalizationStrings.Settings_User_Overview_PageTitle)]
                        </MudText>
                    </MudItem>

                    <MudItem xs="6" Class="d-flex justify-end">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.PersonAdd"
                                   OnClick="NavigateToAddUser">
                            @Loc[nameof(LocalizationStrings.Settings_User_Overview_AddUserButton_Text)]
                        </MudButton>
                    </MudItem>

                </MudGrid>

                @if (_loading)
                {
                    <MudProgressLinear Indeterminate="true" Class="mb-4"/>
                    <MudText Align="Align.Center">
                        @Loc[nameof(LocalizationStrings.Settings_User_Overview_Loading_Message)]
                    </MudText>
                }
                else if (_users.Any())
                {
                    <!-- Page Size Selection -->
                    <MudGrid Class="mb-4">

                        <MudItem xs="6">

                            <MudText Typo="Typo.body1">
                                @string.Format(Loc[nameof(LocalizationStrings.Settings_User_Overview_CurrentCount_MessageTemplate)],
                                    _users.Count,
                                    _totalCount)
                            </MudText>

                        </MudItem>

                        <MudItem xs="6" Class="d-flex justify-end">

                            <MudSelect T="string"
                                       Value="@_pageSize.ToString()"
                                       ValueChanged="OnPageSizeChangedAsync"
                                       Label="@Loc[nameof(LocalizationStrings.Settings_User_Overview_ItemsPerPageSelect_Label)]"
                                       Variant="Variant.Outlined"
                                       Margin="Margin.Dense"
                                       Style="min-width: 120px;">
                                @foreach (string option in _pageSizeOptions)
                                {
                                    <MudSelectItem Value="@option">@option</MudSelectItem>
                                }
                            </MudSelect>

                        </MudItem>

                    </MudGrid>

                    <!-- Users Table -->
                    <MudTable Items="_users"
                              Hover="true"
                              Striped="true"
                              Dense="true">

                        <HeaderContent>
                            <MudTh>@Loc[nameof(LocalizationStrings.Settings_User_Overview_ResultsTable_Username_TableHeader)]</MudTh>
                            <MudTh>@Loc[nameof(LocalizationStrings.Settings_User_Overview_ResultsTable_Status_TableHeader)]</MudTh>
                            <MudTh>@Loc[nameof(LocalizationStrings.Settings_User_Overview_ResultsTable_Role_TableHeader)]</MudTh>
                            <MudTh>@Loc[nameof(LocalizationStrings.Settings_User_Overview_ResultsTable_Created_TableHeader)]</MudTh>
                            <MudTh>@Loc[nameof(LocalizationStrings.Settings_User_Overview_ResultsTable_Actions_TableHeader)]</MudTh>
                        </HeaderContent>

                        <RowTemplate>

                            <MudTd
                                DataLabel="@Loc[nameof(LocalizationStrings.Settings_User_Overview_ResultsTable_Username_TableHeader)]">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" Class="mr-2" Size="Size.Small"/>
                                    <MudText Typo="Typo.body2">@context.UserName</MudText>
                                </div>
                            </MudTd>

                            <MudTd
                                DataLabel="@Loc[nameof(LocalizationStrings.Settings_User_Overview_ResultsTable_Status_TableHeader)]">
                                <MudChip T="string"
                                         Color="@GetUserStatusColor(context)"
                                         Size="Size.Small"
                                         Variant="Variant.Filled"
                                         Icon="@(context.DisabledAt.HasValue ? Icons.Material.Filled.Close : Icons.Material.Filled.Check)">
                                    @GetUserStatusText(context)
                                </MudChip>
                            </MudTd>

                            <MudTd
                                DataLabel="@Loc[nameof(LocalizationStrings.Settings_User_Overview_ResultsTable_Role_TableHeader)]">
                                <MudChip T="string" Color="@(context.IsAdmin ? Color.Warning : Color.Default)"
                                         Size="Size.Small"
                                         Icon="@(context.IsAdmin ? Icons.Material.Filled.AdminPanelSettings : Icons.Material.Filled.Person)">
                                    @GetUserRoleText(context)
                                </MudChip>
                            </MudTd>

                            <MudTd
                                DataLabel="@Loc[nameof(LocalizationStrings.Settings_User_Overview_ResultsTable_Created_TableHeader)]">
                                <MudText Typo="Typo.body2">
                                    @context.CreatedAt.ToString("g")
                                </MudText>
                            </MudTd>

                            <MudTd
                                DataLabel="@Loc[nameof(LocalizationStrings.Settings_User_Overview_ResultsTable_Actions_TableHeader)]">

                                <MudTooltip
                                    Text="@Loc[nameof(LocalizationStrings.Settings_User_Overview_ResultsTable_Actions_EditUser_ToolTipText)]">
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                   Size="Size.Small"
                                                   Color="Color.Primary"
                                                   OnClick="() => NavigateToEditUser(context.Id)"/>
                                </MudTooltip>

                                <MudTooltip Text="@GetToggleStatusTooltipText(context)">
                                    <MudIconButton
                                        Icon="@(context.DisabledAt.HasValue ? Icons.Material.Filled.PersonAdd : Icons.Material.Filled.PersonOff)"
                                        Size="Size.Small"
                                        Color="@(context.DisabledAt.HasValue ? Color.Success : Color.Warning)"
                                        Disabled="@IsCurrentUser(context.Id)"
                                        OnClick="() => ToggleUserStatusAsync(context)"/>
                                </MudTooltip>

                            </MudTd>

                        </RowTemplate>

                    </MudTable>

                    <!-- Pagination -->
                    @if (_totalPages > 1)
                    {
                        <div class="d-flex justify-center">
                            <MudPagination Count="_totalPages"
                                           Selected="_currentPage"
                                           SelectedChanged="OnPageChangedAsync"
                                           ShowFirstButton="true"
                                           ShowLastButton="true"
                                           ShowPreviousButton="true"
                                           ShowNextButton="true"/>
                        </div>
                    }
                }
                else
                {
                    <MudAlert Severity="Severity.Info" Class="mt-4">
                        <MudText Typo="Typo.body2">
                            @Loc[nameof(LocalizationStrings.Settings_User_Overview_ResultsTable_NoResult_Message)]
                        </MudText>
                    </MudAlert>
                }

            </MudPaper>

        </MudItem>

    </MudGrid>

</MudContainer>
