@page "/Settings/Users/{UserId:guid}"

@attribute [Authorize(Roles = "Admin")]
@using HomeBook.Frontend.Abstractions.Contracts
@using HomeBook.Frontend.Core.Icons
@using HomeBook.Frontend.Properties
@using Microsoft.AspNetCore.Components.Authorization

@inject ILocalizationProvider Loc
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IUserManagementProvider UserManagementProvider

<MudContainer Class="mt-4">

    <MudGrid>

        <MudItem xs="12" sm="12" md="4" lg="3" xl="3" xxl="3">

            <SettingsNavMenu/>

        </MudItem>

        <MudItem xs="12" sm="12" md="8" lg="9" xl="9" xxl="9">

            <MudCard Class="mb-4">
                <MudBreadcrumbs Items="_breadcrumbs"/>
            </MudCard>

            @if (_loading)
            {
                <MudProgressLinear Color="Color.Primary"
                                   Indeterminate="true"
                                   Class="mb-4"/>
                <MudText Align="Align.Center">
                    @Loc[nameof(LocalizationStrings.Settings_User_Edit_LoadingUser_Message)]
                </MudText>
            }
            else if (_userModel == null)
            {
                <MudAlert Severity="Severity.Error" Class="mt-4">
                    <MudText>
                        @Loc[nameof(LocalizationStrings.Settings_User_Edit_UserNotFound_Message)]
                    </MudText>
                </MudAlert>
            }
            else
            {
                <!-- User Details Card -->
                <MudCard Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h5">
                                @Loc[nameof(LocalizationStrings.Settings_User_Edit_PageTitle)]
                            </MudText>
                        </CardHeaderContent>
                    </MudCardHeader>

                    <MudCardContent>
                        <EditForm Model="_userModel" OnValidSubmit="HandleValidSubmitAsync">
                            <DataAnnotationsValidator/>

                            <MudGrid>
                                <MudItem xs="12">
                                    <MudTextField @bind-Value="_userModel.Username"
                                                  Label="@Loc[nameof(LocalizationStrings.Settings_User_Edit_Form_Username_Label)]"
                                                  HelperText="@Loc[nameof(LocalizationStrings.Settings_User_Edit_Form_Username_Caption)]"
                                                  Required="true"
                                                  Variant="Variant.Outlined"
                                                  Margin="Margin.Dense"
                                                  For="@(() => _userModel.Username)"/>
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudTextField @bind-Value="_userModel.Password"
                                                  Label="@Loc[nameof(LocalizationStrings.Settings_User_Edit_Form_Password_Label)]"
                                                  HelperText="@Loc[nameof(LocalizationStrings.Settings_User_Edit_Form_Password_Caption)]"
                                                  InputType="@_passwordInputType"
                                                  Variant="Variant.Outlined"
                                                  Margin="Margin.Dense"
                                                  For="@(() => _userModel.Password)"
                                                  Adornment="Adornment.End"
                                                  AdornmentIcon="@_passwordIcon"
                                                  OnAdornmentClick="TogglePasswordVisibility"/>
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudTextField @bind-Value="_userModel.ConfirmPassword"
                                                  Label="@Loc[nameof(LocalizationStrings.Settings_User_Edit_Form_ConfirmPassword_Label)]"
                                                  HelperText="@Loc[nameof(LocalizationStrings.Settings_User_Edit_Form_ConfirmPassword_Caption)]"
                                                  InputType="@_confirmPasswordInputType"
                                                  Variant="Variant.Outlined"
                                                  Margin="Margin.Dense"
                                                  For="@(() => _userModel.ConfirmPassword)"
                                                  Adornment="Adornment.End"
                                                  AdornmentIcon="@_confirmPasswordIcon"
                                                  OnAdornmentClick="ToggleConfirmPasswordVisibility"/>
                                </MudItem>

                                <MudItem xs="12">
                                    <MudSwitch T="bool" @bind-Value="_userModel.IsAdmin"
                                               Label="@Loc[nameof(LocalizationStrings.Settings_User_Edit_AdministratorFlag_Label)]"
                                               Color="Color.Primary"
                                               UnCheckedColor="Color.Default"
                                               Disabled="@IsCurrentUser()"/>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                        @if (IsCurrentUser())
                                        {
                                            @Loc[nameof(LocalizationStrings.Settings_User_Edit_CantChangeOwnAdministratorFlag_Caption)]
                                        }
                                        else
                                        {
                                            @Loc[nameof(LocalizationStrings.Settings_User_Edit_AdministratorFlag_Caption)]
                                        }
                                    </MudText>
                                </MudItem>
                            </MudGrid>
                        </EditForm>
                    </MudCardContent>

                    <MudCardActions>

                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Default"
                                   OnClick="NavigateBack">
                            @Loc[nameof(LocalizationStrings.Settings_User_Edit_CancelButton_Text)]
                        </MudButton>

                        <MudSpacer/>

                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Save"
                                   Disabled="_saving"
                                   OnClick="HandleValidSubmitAsync">
                            @if (_saving)
                            {
                                <MudProgressCircular Size="Size.Small"
                                                     Indeterminate="true"
                                                     Class="mr-2"/>
                                <span>
                                    @Loc[nameof(LocalizationStrings.Settings_User_Edit_Saving_Message)]
                                </span>
                            }
                            else
                            {
                                <span>
                                    @Loc[nameof(LocalizationStrings.Settings_User_Edit_SaveButton_Text)]
                                </span>
                            }
                        </MudButton>

                    </MudCardActions>

                </MudCard>

                <!-- Actions Card -->
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h5">
                                @Loc[nameof(LocalizationStrings.Settings_User_Edit_ActionsHeader_Text)]
                            </MudText>
                        </CardHeaderContent>
                    </MudCardHeader>

                    <MudCardContent Class="pa-0">

                        <UiSettingsItem Icon="@HomeBookIcons.Icons8.Windows11.Filled.NoUser"
                                        IconHexColor="var(--hb-settings-color-user-actions-disable)"
                                        Title="@Loc[nameof(LocalizationStrings.Settings_User_Edit_Actions_EnableDisable_Title)]"
                                        Caption="@Loc[nameof(LocalizationStrings.Settings_User_Edit_Actions_EnableDisable_Caption)]">
                            <MudSwitch T="bool"
                                       Value="_userModel.IsEnabled"
                                       Color="Color.Primary"
                                       Disabled="@(IsCurrentUser() || _saving)"
                                       ValueChanged="@(v => OnUserDisabledChanged(v))"/>
                        </UiSettingsItem>

                        @if (IsCurrentUser())
                        {
                            <MudAlert Dense="true"
                                      Severity="Severity.Warning"
                                      Class="mx-3 mb-3">
                                @Loc[nameof(LocalizationStrings.Settings_User_Edit_Actions_Delete_CantDisableOwnUser_Message)]
                            </MudAlert>
                        }

                        <MudDivider/>

                        <UiSettingsItem Icon="@HomeBookIcons.Icons8.Windows11.Filled.Trash"
                                        IconHexColor="var(--hb-settings-color-user-actions-delete)"
                                        Title="@Loc[nameof(LocalizationStrings.Settings_User_Edit_Actions_Delete_Title)]"
                                        Caption="@Loc[nameof(LocalizationStrings.Settings_User_Edit_Actions_Delete_Caption)]">
                            <MudButton Variant="Variant.Text"
                                       Color="Color.Error"
                                       Disabled="@(IsCurrentUser() || _saving)"
                                       OnClick="ShowDeleteConfirmationAsync">
                                @Loc[nameof(LocalizationStrings.Settings_User_Edit_Actions_DeleteButton_Text)]
                            </MudButton>
                        </UiSettingsItem>

                        @if (IsCurrentUser())
                        {
                            <MudAlert Dense="true"
                                      Severity="Severity.Warning"
                                      Class="mx-3 mb-3">
                                @Loc[nameof(LocalizationStrings.Settings_User_Edit_Actions_Delete_CantDeleteOwnUser_Message)]
                            </MudAlert>
                        }

                    </MudCardContent>

                </MudCard>
            }

        </MudItem>

    </MudGrid>

</MudContainer>
