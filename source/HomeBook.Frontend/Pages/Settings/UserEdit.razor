@page "/Settings/Users/Edit/{UserId:guid}"

@attribute [Authorize(Roles = "Admin")]

@using HomeBook.Client
@using HomeBook.Frontend.Abstractions.Contracts

@inject BackendClient BackendClient
@inject IAuthenticationService AuthenticationService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IDialogService DialogService

<MudContainer Class="mt-4">

    <MudGrid>

        <MudItem xs="12" sm="12" md="4" lg="3" xl="3" xxl="2">

            <SettingsNavMenu/>

        </MudItem>

        <MudItem xs="12" sm="12" md="8" lg="9" xl="9" xxl="10">

            <MudBreadcrumbs Items="_breadcrumbs" Class="mb-4"/>

            @if (_loading)
            {
                <MudProgressLinear Indeterminate="true" Class="mb-4"/>
                <MudText Align="Align.Center">Loading user...</MudText>
            }
            else if (_userModel == null)
            {
                <MudAlert Severity="Severity.Error" Class="mt-4">
                    <MudText>User not found.</MudText>
                </MudAlert>
            }
            else
            {
                <!-- User Details Card -->
                <MudCard Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h5">Edit User</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>

                    <MudCardContent>
                        <EditForm Model="_userModel" OnValidSubmit="HandleValidSubmitAsync">
                            <DataAnnotationsValidator />

                            <MudGrid>
                                <MudItem xs="12" md="6">
                                    <MudTextField @bind-Value="_userModel.Username"
                                                  Label="Username"
                                                  Required="true"
                                                  Variant="Variant.Outlined"
                                                  Margin="Margin.Dense"
                                                  HelperText="Enter a unique username"
                                                  For="@(() => _userModel.Username)"/>
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudTextField @bind-Value="_userModel.Password"
                                                  Label="New Password"
                                                  InputType="InputType.Password"
                                                  Variant="Variant.Outlined"
                                                  Margin="Margin.Dense"
                                                  HelperText="Leave empty to keep current password"
                                                  For="@(() => _userModel.Password)"/>
                                </MudItem>

                                <MudItem xs="12">
                                    <MudSwitch T="bool" @bind-Checked="_userModel.IsAdmin"
                                               Label="Administrator"
                                               Color="Color.Primary"
                                               UnCheckedColor="Color.Default"
                                               Disabled="@IsCurrentUser()"/>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                        @if (IsCurrentUser())
                                        {
                                            <span>You cannot change your own administrator status</span>
                                        }
                                        else
                                        {
                                            <span>Administrators have full access to all features</span>
                                        }
                                    </MudText>
                                </MudItem>
                            </MudGrid>

                            <ValidationSummary />
                        </EditForm>
                    </MudCardContent>

                    <MudCardActions>
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Default"
                                   OnClick="NavigateBack">
                            Cancel
                        </MudButton>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Save"
                                   Disabled="_saving"
                                   OnClick="HandleValidSubmitAsync">
                            @if (_saving)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2"/>
                                <span>Updating...</span>
                            }
                            else
                            {
                                <span>Update User</span>
                            }
                        </MudButton>
                    </MudCardActions>
                </MudCard>

                <!-- Actions Card -->
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">User Actions</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>

                    <MudCardContent>
                        <MudGrid>
                            <MudItem xs="12" md="6">
                                <MudButton Variant="Variant.Outlined"
                                           Color="@(_originalUser?.Disabled.HasValue == true ? Color.Success : Color.Warning)"
                                           StartIcon="@(_originalUser?.Disabled.HasValue == true ? Icons.Material.Filled.PersonAdd : Icons.Material.Filled.PersonOff)"
                                           Disabled="@(IsCurrentUser() || _saving)"
                                           OnClick="ToggleUserStatusAsync"
                                           FullWidth="true">
                                    @(_originalUser?.Disabled.HasValue == true ? "Enable User" : "Disable User")
                                </MudButton>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary mt-1">
                                    @if (IsCurrentUser())
                                    {
                                        <span>You cannot disable your own account</span>
                                    }
                                    else
                                    {
                                        <span>@(_originalUser?.Disabled.HasValue == true ? "Activate this user account" : "Deactivate this user account")</span>
                                    }
                                </MudText>
                            </MudItem>

                            <MudItem xs="12" md="6">
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Error"
                                           StartIcon="@Icons.Material.Filled.Delete"
                                           Disabled="@(IsCurrentUser() || _saving)"
                                           OnClick="ShowDeleteConfirmationAsync"
                                           FullWidth="true">
                                    Delete User
                                </MudButton>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary mt-1">
                                    @if (IsCurrentUser())
                                    {
                                        <span>You cannot delete your own account</span>
                                    }
                                    else
                                    {
                                        <span>Permanently remove this user (cannot be undone)</span>
                                    }
                                </MudText>
                            </MudItem>
                        </MudGrid>
                    </MudCardContent>
                </MudCard>
            }

        </MudItem>

    </MudGrid>

</MudContainer>
